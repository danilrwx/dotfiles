if (v:version < 802 || (v:version == 802 && !has('patch3434')))
  if (v:version < 801 || (v:version == 801 && !has('patch1705')))
    echo "No Vim9 script: Use -u & _vimrc8"
  else
    call popup_notification("No Vim9 script: Use -u & _vimrc8", #{time: 8000})
  endif
  finish
endif
vim9script

if has("eval")
  g:skip_defaults_vim = 1
endif

if filereadable(expand("~/.config/vim/autoload/plug.vim"))
	plug#begin('~/.local/share/vim/plugins')

	Plug 'markonm/traces.vim'
	Plug 'sheerun/vim-polyglot'

	Plug 'tpope/vim-fugitive'
	Plug 'airblade/vim-gitgutter'

	Plug 'yegappan/lsp'

	Plug 'vim-test/vim-test'
	Plug 'sebdah/vim-delve'
	Plug 'charlespascoe/vim-go-syntax'

	Plug 'habamax/vim-dir'

	Plug 'laktak/tome'

	Plug 'vim-fuzzbox/fuzzbox.vim'

	plug#end()
endif

set nocompatible

filetype plugin indent on # Load plugins according to detected filetype.
syntax on                  # Enable syntax highlighting.

set autoindent             # Indent according to previous line.
set expandtab              # Use spaces instead of tabs.
set tabstop=2              # Use 2 spaces for indenting.
set softtabstop=2          # Tab key indents by 2 spaces.
set shiftwidth=2           # >> indents by 2 spaces.
set shiftround             # >> indents to next multiple of 'shiftwidth'.
set paste                  # fix indenting when pasting.

set backspace=indent,eol,start # Make backspace work as you would expect.
set hidden                 # Switch between buffers without having to save first.
set laststatus=2           # Always show statusline.
set display=lastline       # Show as much as possible of the last line.

set showcmd                # Show already typed keys when more are expected.

set incsearch              # Highlight while searching with / or ?.
set hlsearch               # Keep matches highlighted.

set ttyfast                # Faster redrawing.
set lazyredraw             # Only redraw when necessary.

set laststatus=1           # Set minimal bottom statusline

set number                 # Set line numbers
set relativenumber         # Set relative linenumbers

set updatetime=100         # Fast redraw
set signcolumn=yes         # Always render signcolumn
set shortmess=aoOtTI       # Avoid most of the 'Hit Enter ...' messages
set wildmenu               # Better command-line completion
set mouse=a                # Enable mouse support
set laststatus=0           # Disable status bar
set autochdir              # Auto change dir to current file

# The fish shell is not very compatible to other shells and unexpectedly
# breaks things that use 'shell'.
if &shell =~# 'fish$'
	set shell=exepath('bash')
endif

# Made grep great again
if executable('ugrep')
  set grepprg=ugrep\ -RInk\ --tabs=1\ --ignore-files\ --exclude='zz_generated*'\ --exclude-dir='generated'
  set grepformat=%f:%l:%c:%m,%f+%l+%c+%m,%-G%f\\\|%l\\\|%c\\\|%m
else
  set grepprg=grep\ --exclude='*zz_generated*'\ --exclude-dir='generated'
endif

# Put all temporary files under the same directory.
# https://github.com/mhinz/vim-galore#temporary-files
set backup
set backupdir=$XDG_CONFIG_HOME/vim/files/backup/
set backupext=-vimbackup
set backupskip=
set directory=$XDG_CONFIG_HOME/vim/files/swap/
set updatecount=100
set undofile
set undodir=$XDG_CONFIG_HOME/vim/files/undo/

# mark trailing spaces as errors
match errorMsg '\s\+$'

colorscheme torte
highlight Normal ctermbg=none
highlight SignColumn ctermbg=none
highlight DiffAdd ctermfg=16
highlight DiffChange ctermfg=16
highlight DiffDelete ctermfg=16

if has('patch-8.1.0311')
  packadd! cfilter
endif

if has('patch-9.1.0375')
  packadd! comment
endif

if has('patch-9.1.1230')
  packadd! hlyank
endif

if has('patch-9.0.1799')
  packadd! editorconfig
endif

g:mapleader = " "

nnoremap <silent> <leader>q :call ToggleQuickFix()<cr>
nnoremap <c-j> :cnext<cr>
nnoremap <c-k> :cprev<cr>

nnoremap <c-d> <c-d>zz<cr>
nnoremap <c-u> <c-u>zz<cr>

nnoremap <c-l> :nohl<cr>

nnoremap <silent> <leader>tr :TestNearest<cr>
nnoremap <silent> <leader>tt :TestFile<cr>
nnoremap <silent> <leader>td :DlvTestCurrent<cr>

nnoremap <silent> <leader>db :DlvToggleBreakpoint<cr>
nnoremap <silent> <leader>dc :DlvConnect :2345<cr>

nnoremap <silent> <leader>gl :tab Git log --follow -p %<cr>
nnoremap <silent> <leader>gL :tab Git log<cr>
nnoremap <silent> <leader>gb :tab Git blame<cr>

nnoremap <silent> ghs <cmd>GitGutterStageHunk<cr>
nnoremap <silent> ghu <cmd>GitGutterUndoHunk<cr>
nnoremap <silent> ghp <cmd>GitGutterPreviewHunk<cr>

nnoremap <silent> - <cmd>Dir<cr>

g:gitgutter_sign_priority = 0
g:gitgutter_preview_win_floating = 1

var lspOpts = {
	autoHighlightDiags: true,
	useQuickfixForLocations: true,
	semanticHighlight: true,
	showInlayHints: false,
}

autocmd User LspSetup call LspOptionsSet(lspOpts)

var lspServers = [{
	name: 'golang',
	filetype: ['go', 'gomod'],
	path: exepath('gopls'),
	args: ['serve'],
	syncInit: false,
	workspaceConfig: {
		gopls: {
			hints: {
				assignVariableTypes: true,
				compositeLiteralFields: true,
				compositeLiteralTypes: true,
				constantValues: true,
				functionTypeParameters: true,
				parameterNames: true,
				rangeVariableTypes: true,
				semanticTokens: false
			}
		}
	}
},
{
  name: 'clangd',
  filetype: ['c', 'cpp'],
  path: exepath('clangd'),
  args: ['--background-index']
},
]

autocmd User LspSetup call LspAddServer(lspServers)

def On_lsp_buffer_enabled()
  setlocal omnifunc=g:LspOmniFunc
  setlocal tagfunc=lsp#lsp#TagFunc
  setlocal formatexpr=lsp#lsp#FormatExpr()

  nnoremap grr :LspShowReferences<cr>
  nnoremap gri :LspPeekImpl<cr>
  nnoremap K   :LspHover<cr>
  nnoremap grs :LspDocumentSymbol<cr>
  nnoremap grS :LspSymbolSearch<cr>
  nnoremap gra :LspCodeAction<cr>
  nnoremap grc :LspCodeLens<cr>
  nnoremap grn :LspRename<cr>
  nnoremap grf :LspFormat<cr>
  nnoremap <c-w>d :LspDiag current<cr>
  nnoremap [d :LspDiag prev<cr>
  nnoremap ]d :LspDiag next<cr>

  autocmd! BufWritePre *.go call execute('LspFormat')
enddef
autocmd User LspAttached call On_lsp_buffer_enabled()

# def g:TrimWhitespace()
#   var save = winsaveview()
#   keeppatterns :%s/\s\+$//e
#   winrestview(save)
# enddef
# autocmd BufWritePre * call TrimWhitespace()

def g:ToggleQuickFix()
  if empty(filter(getwininfo(), 'v:val.quickfix'))
    copen
  else
    cclose
  endif
enddef

